name: Sync Movidesk - Tickets Merged

on:
  workflow_dispatch:
    inputs:
      backfill_days:
        description: "Quantos dias para trás sincronizar"
        required: false
        default: "30"
      window_days:
        description: "Tamanho da janela (dias) por chamada no /tickets/merged"
        required: false
        default: "7"
  schedule:
    # a cada 6 horas (UTC). Ajuste como quiser.
    - cron: "15 */6 * * *"

concurrency:
  group: movidesk-sync-tickets-merged
  cancel-in-progress: true

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install requests psycopg2-binary

      # MIGRAÇÃO: garante schema/tabela/colunas mínimas para o script novo
      - name: Migrate DB (ensure tickets_mesclados columns)
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          DB_SCHEMA: visualizacao_resolvidos
          TABLE_NAME: tickets_mesclados
        run: |
          python - <<'PY'
          import os
          import psycopg2

          dsn = os.environ["DATABASE_URL"]
          schema = os.getenv("DB_SCHEMA", "visualizacao_resolvidos")
          table = os.getenv("TABLE_NAME", "tickets_mesclados")

          ddl = f'''
          CREATE SCHEMA IF NOT EXISTS "{schema}";

          CREATE TABLE IF NOT EXISTS "{schema}"."{table}" (
            ticket_id         BIGINT NOT NULL,
            merged_ticket_id  BIGINT NULL,
            merged_tickets    INTEGER NULL,
            merged_tickets_ids TEXT NULL,
            last_update       TIMESTAMP NULL,
            updated_at        TIMESTAMPTZ NOT NULL DEFAULT NOW()
          );

          ALTER TABLE "{schema}"."{table}" ADD COLUMN IF NOT EXISTS merged_ticket_id BIGINT;
          ALTER TABLE "{schema}"."{table}" ADD COLUMN IF NOT EXISTS merged_tickets INTEGER;
          ALTER TABLE "{schema}"."{table}" ADD COLUMN IF NOT EXISTS merged_tickets_ids TEXT;
          ALTER TABLE "{schema}"."{table}" ADD COLUMN IF NOT EXISTS last_update TIMESTAMP;
          ALTER TABLE "{schema}"."{table}" ADD COLUMN IF NOT EXISTS updated_at TIMESTAMPTZ;

          -- índice para UPSERT por par (ticket_id, merged_ticket_id)
          CREATE UNIQUE INDEX IF NOT EXISTS tickets_mesclados_ticket_merged_uq
            ON "{schema}"."{table}" (ticket_id, merged_ticket_id);
          '''
          conn = psycopg2.connect(dsn)
          conn.autocommit = True
          cur = conn.cursor()
          cur.execute(ddl)
          cur.close()
          conn.close()
          print("DB migration OK")
          PY

      - name: Run sync_tickets_merged.py
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          MOVIDESK_TOKEN: ${{ secrets.MOVIDESK_TOKEN }}

          # se seu script usa isso:
          DB_SCHEMA: visualizacao_resolvidos
          TABLE_NAME: tickets_mesclados

          # inputs (com defaults)
          BACKFILL_DAYS: ${{ github.event.inputs.backfill_days || '30' }}
          WINDOW_DAYS: ${{ github.event.inputs.window_days || '7' }}

          # opcional (se seu script tiver throttle)
          THROTTLE_SEC: "6.5"
        run: |
          python -u sync_tickets_merged.py
