name: Sync Movidesk -> Auditoria resolvidos (resolvedIn) + backfill
on:
  schedule:
    - cron: "0 6 * * *"
  workflow_dispatch: {}

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - run: sudo apt-get update && sudo apt-get install -y postgresql-client

      # DDL seguro (SEM UPDATE em colunas GENERATED)
      - name: Prepare resolvidos_acoes (safe DDL)
        env:
          NEON_DSN: ${{ secrets.NEON_DSN }}
        run: |
          psql "$NEON_DSN" -v ON_ERROR_STOP=1 <<'SQL'
          begin;

          create schema if not exists visualizacao_resolvidos;

          create table if not exists visualizacao_resolvidos.resolvidos_acoes (
            ticket_id integer primary key,
            acoes jsonb not null default '[]'::jsonb
          );

          create or replace function visualizacao_resolvidos._count_desc_publi(js jsonb)
          returns integer language sql immutable as $$
            select coalesce(sum(
              case when coalesce((a->>'type')::int,0) = 2
                    and nullif(a->>'description','') is not null
                   then 1 else 0 end
            ),0)
            from jsonb_array_elements(coalesce(js,'[]'::jsonb)) as a;
          $$;

          create or replace function visualizacao_resolvidos._count_desc_inter(js jsonb)
          returns integer language sql immutable as $$
            select coalesce(sum(
              case when coalesce((a->>'type')::int,0) = 1
                    and nullif(a->>'description','') is not null
                   then 1 else 0 end
            ),0)
            from jsonb_array_elements(coalesce(js,'[]'::jsonb)) as a;
          $$;

          -- cria as colunas como GENERATED se não existirem; se já existirem, não mexe
          do $$
          begin
            if not exists (
              select 1 from information_schema.columns
               where table_schema='visualizacao_resolvidos'
                 and table_name='resolvidos_acoes'
                 and column_name='qtd_acoes_descricao_publi'
            ) then
              execute $gx$
                alter table visualizacao_resolvidos.resolvidos_acoes
                add column qtd_acoes_descricao_publi integer
                  generated always as (visualizacao_resolvidos._count_desc_publi(acoes)) stored
              $gx$;
            end if;

            if not exists (
              select 1 from information_schema.columns
               where table_schema='visualizacao_resolvidos'
                 and table_name='resolvidos_acoes'
                 and column_name='qtd_acoes_descricao_inter'
            ) then
              execute $gx$
                alter table visualizacao_resolvidos.resolvidos_acoes
                add column qtd_acoes_descricao_inter integer
                  generated always as (visualizacao_resolvidos._count_desc_inter(acoes)) stored
              $gx$;
            end if;
          end $$;

          -- trigger só se ALGUMA coluna não for GENERATED
          create or replace function visualizacao_resolvidos._resolvidos_acoes_fill_counts()
          returns trigger language plpgsql as $$
          declare
            gen_pub  text;
            gen_inter text;
          begin
            select is_generated into gen_pub
              from information_schema.columns
             where table_schema='visualizacao_resolvidos'
               and table_name='resolvidos_acoes'
               and column_name='qtd_acoes_descricao_publi';

            select is_generated into gen_inter
              from information_schema.columns
             where table_schema='visualizacao_resolvidos'
               and table_name='resolvidos_acoes'
               and column_name='qtd_acoes_descricao_inter';

            if coalesce(gen_pub,'NEVER') <> 'ALWAYS' then
              new.qtd_acoes_descricao_publi := visualizacao_resolvidos._count_desc_publi(new.acoes);
            end if;

            if coalesce(gen_inter,'NEVER') <> 'ALWAYS' then
              new.qtd_acoes_descricao_inter := visualizacao_resolvidos._count_desc_inter(new.acoes);
            end if;

            return new;
          end $$;

          do $$
          declare
            gen_pub  text;
            gen_inter text;
            need_trig boolean;
          begin
            select is_generated into gen_pub
              from information_schema.columns
             where table_schema='visualizacao_resolvidos'
               and table_name='resolvidos_acoes'
               and column_name='qtd_acoes_descricao_publi';

            select is_generated into gen_inter
              from information_schema.columns
             where table_schema='visualizacao_resolvidos'
               and table_name='resolvidos_acoes'
               and column_name='qtd_acoes_descricao_inter';

            need_trig := (coalesce(gen_pub,'NEVER') <> 'ALWAYS')
                      or (coalesce(gen_inter,'NEVER') <> 'ALWAYS');

            if exists (
              select 1 from pg_trigger
               where tgname='tr_resolvidos_acoes_fill_counts'
                 and tgrelid='visualizacao_resolvidos.resolvidos_acoes'::regclass
            ) then
              execute 'drop trigger tr_resolvidos_acoes_fill_counts on visualizacao_resolvidos.resolvidos_acoes';
            end if;

            if need_trig then
              execute '
                create trigger tr_resolvidos_acoes_fill_counts
                before insert or update of acoes on visualizacao_resolvidos.resolvidos_acoes
                for each row execute function visualizacao_resolvidos._resolvidos_acoes_fill_counts()
              ';
            end if;
          end $$;

          commit;
          SQL

      - run: pip install requests psycopg2-binary

      # Auditoria (resolvedIn nos últimos 2 dias) cria/atualiza audit_* e NÃO mexe em colunas GENERATED
      - name: Audit scan (resolvedIn only)
        env:
          MOVIDESK_TOKEN: ${{ secrets.MOVIDESK_TOKEN }}
          NEON_DSN: ${{ secrets.NEON_DSN }}
          MOVIDESK_THROTTLE: "0.25"
        run: python audit_recent_resolved_scan.py

      # Backfill dos tickets faltantes (tickets_resolvidos, resolvidos_acoes.acoes, detail_control)
      - name: Backfill missing tickets
        env:
          MOVIDESK_TOKEN: ${{ secrets.MOVIDESK_TOKEN }}
          NEON_DSN: ${{ secrets.NEON_DSN }}
          MOVIDESK_THROTTLE: "0.25"
        run: python reprocess_missing.py

      - name: Assert remaining missing (log)
        env:
          NEON_DSN: ${{ secrets.NEON_DSN }}
        run: |
          python - <<'PY'
          import os, psycopg2
          with psycopg2.connect(os.environ["NEON_DSN"]) as c, c.cursor() as cur:
            cur.execute("select count(*) from visualizacao_resolvidos.audit_recent_missing")
            print("missing_after_backfill:", cur.fetchone()[0])
          PY
