  - name: Ensure schemas & tables exist
    env:
      NEON_DSN: ${{ secrets.NEON_DSN }}
    run: |
      psql "$NEON_DSN" <<EOF
      CREATE SCHEMA IF NOT EXISTS visualizacao_resolucao;
      CREATE TABLE IF NOT EXISTS visualizacao_resolucao.resolucao_por_status (
        ticket_id         INTEGER   NOT NULL,
        protocol          TEXT,
        status            TEXT      NOT NULL,
        justificativa     TEXT      NOT NULL,
        seconds_utl       INTEGER,
        permanency_time_fulltime_seconds DOUBLE PRECISION,
        changed_by        JSONB,
        changed_date      TIMESTAMP,
        agent_name        TEXT,
        team_name         TEXT,
        imported_at       TIMESTAMP DEFAULT NOW(),
        PRIMARY KEY(ticket_id, status, justificativa)
      );
      -- agora removemos o NOT NULL de agent_name e team_name
      ALTER TABLE visualizacao_resolucao.resolucao_por_status
        ALTER COLUMN agent_name DROP NOT NULL,
        ALTER COLUMN team_name  DROP NOT NULL;
      EOF
