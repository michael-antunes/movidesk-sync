name: Setup resolvidos_acoes
on:
  workflow_dispatch: {}
jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: sudo apt-get update && sudo apt-get install -y postgresql-client
      - env:
          NEON_DSN: ${{ secrets.NEON_DSN }}
        run: |
          psql "$NEON_DSN" -v ON_ERROR_STOP=1 <<'SQL'
          BEGIN;

          -- NADA de CREATE/ALTER/UPDATE nas colunas geradas.
          -- Só limpamos artefatos antigos, se existirem:

          -- Trigger antiga (não é mais usada com colunas GENERATED):
          DROP TRIGGER IF EXISTS tr_resolvidos_acoes_fill_counts
            ON visualizacao_resolvidos.resolvidos_acoes;

          -- Funções antigas da trigger (opcional):
          DROP FUNCTION IF EXISTS visualizacao_resolvidos._resolvidos_acoes_fill_counts();
          DROP FUNCTION IF EXISTS visualizacao_resolvidos._count_desc_publi(jsonb);
          DROP FUNCTION IF EXISTS visualizacao_resolvidos._count_desc_inter(jsonb);

          COMMIT;
          SQL
