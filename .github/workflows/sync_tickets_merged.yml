name: Movidesk - Tickets mesclados (merged)

on:
  workflow_dispatch:
    inputs:
      dias_atras:
        description: "Quantos dias para trás buscar (padrão 2)"
        required: false
        default: "2"
      janela_dias:
        description: "Tamanho da janela em dias (padrão 1)"
        required: false
        default: "1"
  # serve como “watchdog” caso algum run quebre e pare de se auto-disparar
  schedule:
    - cron: "0 * * * *"  # 1x por hora

concurrency:
  group: movidesk-merged-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: read
  actions: write

jobs:
  merged:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    outputs:
      dias_atras: ${{ steps.vars.outputs.dias_atras }}
      janela_dias: ${{ steps.vars.outputs.janela_dias }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - run: python -m pip install --upgrade pip requests psycopg2-binary

      - name: Resolve inputs (dispatch vs schedule)
        id: vars
        shell: bash
        run: |
          echo "dias_atras=${{ (github.event_name == 'workflow_dispatch' && github.event.inputs.dias_atras) || '2' }}" >> "$GITHUB_OUTPUT"
          echo "janela_dias=${{ (github.event_name == 'workflow_dispatch' && github.event.inputs.janela_dias) || '1' }}" >> "$GITHUB_OUTPUT"

      - name: Run sync_tickets_merged.py
        env:
          MOVIDESK_TOKEN: ${{ secrets.MOVIDESK_TOKEN }}
          NEON_DSN: ${{ secrets.NEON_DSN }}
          DIAS_ATRAS: ${{ steps.vars.outputs.dias_atras }}
          JANELA_DIAS: ${{ steps.vars.outputs.janela_dias }}
        run: python sync_tickets_merged.py

  rerun_self:
    needs: merged
    if: ${{ needs.merged.result == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Re-run this workflow (loop)
        uses: actions/github-script@v7
        env:
          DIAS_ATRAS: ${{ needs.merged.outputs.dias_atras }}
          JANELA_DIAS: ${{ needs.merged.outputs.janela_dias }}
        with:
          github-token: ${{ github.token }}
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'sync_tickets_merged.yml',
              ref: context.ref,
              inputs: {
                dias_atras: process.env.DIAS_ATRAS,
                janela_dias: process.env.JANELA_DIAS
              }
            })
