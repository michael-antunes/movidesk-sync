name: Movidesk - Tickets mesclados (merged)

on:
  workflow_call:
    inputs:
      lookback_days:
        description: Quantos dias para trás buscar
        type: number
        default: 2
        required: false
      window_days:
        description: Tamanho da janela em dias
        type: number
        default: 1
        required: false

  workflow_dispatch:
    inputs:
      lookback_days:
        description: Quantos dias para trás buscar (padrão 2)
        required: false
        default: "2"
      window_days:
        description: Tamanho da janela em dias (padrão 1)
        required: false
        default: "1"

concurrency:
  group: movidesk-merged-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: read
  actions: write

jobs:
  merged:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - run: date -u && echo "Branch=$GITHUB_REF"
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
      - run: pip install requests psycopg2-binary

      - name: Defaults
        run: |
          echo "LOOKBACK_DAYS=2" >> $GITHUB_ENV
          echo "WINDOW_DAYS=1" >> $GITHUB_ENV
          echo "RPM=9" >> $GITHUB_ENV
          echo "PAGE_SIZE=100" >> $GITHUB_ENV
          echo "BATCH_SIZE=2000" >> $GITHUB_ENV

      - name: Override from workflow_dispatch
        if: ${{ github.event_name == 'workflow_dispatch' }}
        run: |
          echo "LOOKBACK_DAYS=${{ github.event.inputs.lookback_days }}" >> $GITHUB_ENV
          echo "WINDOW_DAYS=${{ github.event.inputs.window_days }}" >> $GITHUB_ENV

      - name: Override from workflow_call
        if: ${{ github.event_name == 'workflow_call' }}
        run: |
          echo "LOOKBACK_DAYS=${{ inputs.lookback_days }}" >> $GITHUB_ENV
          echo "WINDOW_DAYS=${{ inputs.window_days }}" >> $GITHUB_ENV

      - name: Sync tickets merged
        env:
          NEON_DSN: ${{ secrets.NEON_DSN }}
          MOVIDESK_TOKEN: ${{ secrets.MOVIDESK_TOKEN }}
          MOVIDESK_BASE_URL: "https://api.movidesk.com/public/v1"
          LOOKBACK_DAYS: ${{ env.LOOKBACK_DAYS }}
          WINDOW_DAYS: ${{ env.WINDOW_DAYS }}
          RPM: ${{ env.RPM }}
          PAGE_SIZE: ${{ env.PAGE_SIZE }}
          BATCH_SIZE: ${{ env.BATCH_SIZE }}
          LOG_LEVEL: "INFO"
        run: python sync_tickets_merged.py

  rerun:
    needs: merged
    if: ${{ needs.merged.result == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'sync_tickets_merged.yml',
              ref: 'main'
            })
