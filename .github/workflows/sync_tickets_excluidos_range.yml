- name: Check done
  shell: bash
  env:
    NEON_DSN: ${{ secrets.NEON_DSN }}
    SCHEMA: visualizacao_resolvidos
    CONTROL_TABLE: range_scan_control
  run: |
    set -euo pipefail
    DONE=$(python - <<'PY'
    import os, psycopg2
    dsn=os.environ["NEON_DSN"]
    schema=os.getenv("SCHEMA","visualizacao_resolvidos")
    ctl=os.getenv("CONTROL_TABLE","range_scan_control")

    c=psycopg2.connect(dsn)
    cur=c.cursor()
    cur.execute(f'SELECT id_atual_excluido::bigint, id_final::bigint FROM "{schema}"."{ctl}" LIMIT 1')
    r=cur.fetchone()
    cur.close()
    c.close()

    if not r or r[0] is None or r[1] is None:
      print("0")
    else:
      ptr=int(r[0])
      end=int(r[1])
      print("1" if ptr <= end else "0")
    PY
    )
    echo "done=${DONE}" | tee done_out.txt
