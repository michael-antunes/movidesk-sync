name: Movidesk - Range scan reset (weekly)

on:
  schedule:
    - cron: "0 23 * * 4"   # 23:00 UTC de quinta = 20:00 BRT
  workflow_dispatch: {}

jobs:
  reset:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - run: pip install psycopg2-binary
      - name: Reset cursor (quinta 20h BRT)
        env:
          NEON_DSN: ${{ secrets.NEON_DSN }}
        run: |
          python - <<'PY'
          import os, psycopg2
          dsn = os.environ["NEON_DSN"]
          with psycopg2.connect(dsn) as c, c.cursor() as cur:
              cur.execute("""
                  insert into visualizacao_resolvidos.range_scan_control(data_inicio,data_fim,ultima_data_validada)
                  values (now(), timestamptz '2018-01-01 00:00:00+00', now())
                  on conflict do nothing
              """)
              cur.execute("""
                  update visualizacao_resolvidos.range_scan_control
                     set data_inicio = now(),
                         data_fim = timestamptz '2018-01-01 00:00:00+00',
                         ultima_data_validada = now()
              """)
              c.commit()
          print("reset feito.")
          PY
