name: Sync Movidesk -> Detalhes resolvidos
on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch: {}
jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - run: sudo apt-get update && sudo apt-get install -y postgresql-client

      # --- DDL tickets_resolvidos (mantém igual ao que você já usa) ---
      - env:
          NEON_DSN: ${{ secrets.NEON_DSN }}
        run: |
          psql "$NEON_DSN" -v ON_ERROR_STOP=1 <<'SQL'
          begin;
          create schema if not exists visualizacao_resolvidos;

          alter table if exists visualizacao_resolvidos.detail_control drop column if exists synced_at;

          do $$
          begin
            if exists (select 1 from information_schema.columns where table_schema='visualizacao_resolvidos' and table_name='sync_control' and column_name='last_index_run_at') then
              execute 'alter table visualizacao_resolvidos.sync_control drop column last_index_run_at';
            end if;
            if exists (select 1 from information_schema.columns where table_schema='visualizacao_resolvidos' and table_name='sync_control' and column_name='last_detail_run_at') then
              execute 'alter table visualizacao_resolvidos.sync_control drop column last_detail_run_at';
            end if;
          end $$;

          create table if not exists visualizacao_resolvidos.tickets_resolvidos (
            ticket_id integer primary key,
            status text not null,
            last_resolved_at timestamptz,
            last_closed_at timestamptz,
            responsible_id bigint,
            responsible_name text,
            organization_id text,
            organization_name text,
            origin text,
            category text,
            urgency text,
            service_first_level text,
            service_second_level text,
            service_third_level text
          );

          insert into visualizacao_resolvidos.sync_control(name,last_update)
          values ('detail_control', now() - interval '180 days')
          on conflict (name) do nothing;

          insert into visualizacao_resolvidos.sync_control(name,last_update)
          values ('tickets_resolvidos', now() - interval '180 days')
          on conflict (name) do nothing;

          delete from visualizacao_resolvidos.sync_control where name not in ('detail_control','tickets_resolvidos');

          commit;
          SQL

      # --- DDL resolvidos_acoes: trata JSON/HTML no Neon e cria colunas geradas ---
      - env:
          NEON_DSN: ${{ secrets.NEON_DSN }}
        run: |
          psql "$NEON_DSN" -v ON_ERROR_STOP=1 <<'SQL'
          begin;
          create schema if not exists visualiz
