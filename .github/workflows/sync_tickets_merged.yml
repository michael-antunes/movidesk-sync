name: Sync Tickets Merged (Movidesk)

on:
  workflow_dispatch:
  schedule:
    # 03:20 UTC ~ 00:20 (BRT, America/Sao_Paulo) dependendo do DST (normalmente sem DST)
    - cron: "20 3 * * *"

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install requests psycopg2-binary

      - name: Validate required env
        env:
          MOVIDESK_TOKEN: ${{ secrets.MOVIDESK_TOKEN }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          PGHOST: ${{ secrets.PGHOST }}
          PGDATABASE: ${{ secrets.PGDATABASE }}
          PGUSER: ${{ secrets.PGUSER }}
          PGPASSWORD: ${{ secrets.PGPASSWORD }}
        run: |
          python - <<'PY'
          import os, sys
          token = os.getenv("MOVIDESK_TOKEN")
          if not token:
            print("Missing secret: MOVIDESK_TOKEN")
            sys.exit(1)

          db_url = os.getenv("DATABASE_URL")
          has_pg = all(os.getenv(k) for k in ["PGHOST","PGDATABASE","PGUSER","PGPASSWORD"])
          if not (db_url or has_pg):
            print("Missing DB secrets: set DATABASE_URL or PGHOST/PGDATABASE/PGUSER/PGPASSWORD")
            sys.exit(1)

          print("OK: required env present")
          PY

      - name: Run sync
        env:
          # API
          MOVIDESK_TOKEN: ${{ secrets.MOVIDESK_TOKEN }}
          MOVIDESK_BASE_URL: "https://api.movidesk.com/public/v1"

          # DB (use DATABASE_URL OR PG*)
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          PGHOST: ${{ secrets.PGHOST }}
          PGDATABASE: ${{ secrets.PGDATABASE }}
          PGUSER: ${{ secrets.PGUSER }}
          PGPASSWORD: ${{ secrets.PGPASSWORD }}
          PGPORT: ${{ secrets.PGPORT }}

          # Job config
          DB_SCHEMA: "visualizacao_resolvidos"
          DB_TABLE: "tickets_mesclados"
          LOOKBACK_DAYS: "30"
          WINDOW_DAYS: "7"
          REQUEST_SLEEP_S: "0.4"
        run: |
          python sync_tickets_merged.py
