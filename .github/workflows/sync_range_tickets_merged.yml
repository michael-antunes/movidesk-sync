name: scanner tickets merged (range)

"on":
  workflow_dispatch:
  schedule:
    - cron: "*/10 * * * *"

permissions:
  contents: read

concurrency:
  group: scanner-tickets-merged
  cancel-in-progress: false

jobs:
  run:
    runs-on: ubuntu-latest

    env:
      # Movidesk (Secrets)
      MOVI_TOKEN: ${{ secrets.MOVI_TOKEN }}

      # Postgres (Secrets)
      DATABASE_URL: ${{ secrets.DATABASE_URL }}

      # Range (Variables)
      ID_ATUAL_MERGED: ${{ vars.ID_ATUAL_MERGED }}
      ID_FINAL_MERGED: ${{ vars.ID_FINAL_MERGED }}

      BATCH_SIZE: "80"

      DB_SCHEMA: visualizacao_resolvidos
      MERGED_TABLE: tickets_mesclados
      STATE_TABLE: tickets_mesclados_scan_state
      MISSING_TABLE: tickets_mesclados_scan_missing

      LOG_LEVEL: INFO
      DRY_RUN: "false"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests psycopg2-binary

      - name: Validate env presence (no secrets printed)
        run: |
          python - << 'PY'
          import os
          keys = ["MOVI_TOKEN","ID_ATUAL_MERGED","ID_FINAL_MERGED","DATABASE_URL"]
          for k in keys:
            print(f"{k} set? {bool(os.getenv(k))}")
          PY

      - name: Run scanner
        run: |
          python sync_range_tickets_merged.py
