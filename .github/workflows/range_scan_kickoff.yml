name: Movidesk - Kickoff (range/date)

on:
  workflow_dispatch:
    inputs:
      start_date:
        description: "Data inicial (YYYY-MM-DD). Se vazio, usa ontem."
        required: false
        default: ""
      end_date:
        description: "Data final (YYYY-MM-DD). Se vazio, usa hoje."
        required: false
        default: ""
      window_days:
        description: "Tamanho da janela (dias) se start/end estiverem vazios."
        required: false
        default: "2"
      branch:
        description: "Branch para disparar os workflows dependentes (default: branch atual)."
        required: false
        default: ""

jobs:
  kickoff:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write
    concurrency:
      group: movidesk-db
      cancel-in-progress: true

    steps:
      - name: Cancelar workflows que mexem no banco (queued/in_progress)
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const branchInput = (context.payload.inputs && context.payload.inputs.branch) ? String(context.payload.inputs.branch).trim() : "";
            const branch = branchInput || context.ref.replace("refs/heads/", "");
            const workflowFiles = [
              "sync_resolved_detail.yml",
              "detail_watchdog.yml",
              "audit_recent_resolved_scan.yml",
              "audit_resolved_daily.yml",
              "id_scan_to_audit_missing.yml",
              "range_scan_to_audit.yml",
              "sync_range_tickets_merged.yml",
              "sync_tickets_merged.yml",
              "sync_tickets_abertos.yml",
              "sync_tickets_abertos_raw.yml",
              "sync_tickets_excluidos.yml"
            ];

            async function listRuns(workflow_id, status) {
              try {
                const res = await github.rest.actions.listWorkflowRuns({
                  owner, repo, workflow_id,
                  branch,
                  status,
                  per_page: 50
                });
                return res.data.workflow_runs || [];
              } catch (e) {
                core.warning(`nao consegui listar runs de ${workflow_id} (${status}): ${e.message}`);
                return [];
              }
            }

            async function cancelRun(run_id) {
              try {
                await github.rest.actions.cancelWorkflowRun({ owner, repo, run_id });
                core.info(`cancel_requested run_id=${run_id}`);
              } catch (e) {
                core.warning(`falha ao cancelar run_id=${run_id}: ${e.message}`);
              }
            }

            core.info(`branch=${branch}`);
            for (const wf of workflowFiles) {
              const runsQueued = await listRuns(wf, "queued");
              const runsInProgress = await listRuns(wf, "in_progress");
              const runs = [...runsQueued, ...runsInProgress];
              const unique = new Map();
              for (const r of runs) unique.set(r.id, r);
              for (const r of unique.values()) {
                await cancelRun(r.id);
              }
            }

            const maxWaitSeconds = 240;
            const pollEverySeconds = 8;
            const started = Date.now();

            while (true) {
              let anyRunning = false;
              for (const wf of workflowFiles) {
                const runsQueued = await listRuns(wf, "queued");
                const runsInProgress = await listRuns(wf, "in_progress");
                if (runsQueued.length > 0 || runsInProgress.length > 0) {
                  anyRunning = true;
                  core.info(`ainda executando: ${wf} queued=${runsQueued.length} in_progress=${runsInProgress.length}`);
                }
              }
              const elapsed = Math.floor((Date.now() - started) / 1000);
              if (!anyRunning) {
                core.info("ok: nenhum workflow concorrente em execução");
                break;
              }
              if (elapsed >= maxWaitSeconds) {
                core.warning("continuando mesmo com workflows ainda em execução (timeout de espera)");
                break;
              }
              await new Promise(r => setTimeout(r, pollEverySeconds * 1000));
            }

      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: python -m pip install --upgrade pip requests psycopg2-binary

      - name: Run range_scan_kickoff.py
        env:
          NEON_DSN: ${{ secrets.NEON_DSN }}
        run: |
          python range_scan_kickoff.py \
            --start-date "${{ github.event.inputs.start_date }}" \
            --end-date "${{ github.event.inputs.end_date }}" \
            --window-days "${{ github.event.inputs.window_days }}"

      - name: Set branch var
        id: branch
        run: |
          if [ -n "${{ github.event.inputs.branch }}" ]; then
            echo "value=${{ github.event.inputs.branch }}" >> $GITHUB_OUTPUT
          else
            echo "value=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          fi

      - name: Dispatch Movidesk - Range scan (tickets merged) (loop)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BRANCH: ${{ steps.branch.outputs.value }}
        run: |
          set -euo pipefail
          curl -sS -X POST \
            -H "Authorization: token ${GH_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${GITHUB_REPOSITORY}/actions/workflows/sync_range_tickets_merged.yml/dispatches" \
            -d "{\"ref\":\"${BRANCH}\"}"

      - name: Dispatch Movidesk - Range scan to audit (loop)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BRANCH: ${{ steps.branch.outputs.value }}
        run: |
          set -euo pipefail
          curl -sS -X POST \
            -H "Authorization: token ${GH_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${GITHUB_REPOSITORY}/actions/workflows/range_scan_to_audit.yml/dispatches" \
            -d "{\"ref\":\"${BRANCH}\"}"

      - name: Dispatch Movidesk - ID scan (API) -> audit_recent_missing
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BRANCH: ${{ steps.branch.outputs.value }}
        run: |
          set -euo pipefail
          curl -sS -X POST \
            -H "Authorization: token ${GH_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${GITHUB_REPOSITORY}/actions/workflows/id_scan_to_audit_missing.yml/dispatches" \
            -d "{\"ref\":\"${BRANCH}\"}"
