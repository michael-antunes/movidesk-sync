name: Movidesk - Range scan (tickets merged) (loop)

on:
  workflow_dispatch:
    inputs:
      limit:
        description: "Quantos tickets validar por execução"
        required: true
        default: "10"
      rpm:
        description: "Requests por minuto (API Movidesk)"
        required: true
        default: "10"
      dry_run:
        description: "Se true, não grava no banco"
        required: true
        default: "false"
      debug_ticket_ids:
        description: "IDs para debugar no log (ex: 302353;302446)"
        required: false
        default: ""
      lock_timeout_ms:
        description: "Timeout de lock no Postgres (ms)"
        required: true
        default: "5000"
      write_retries:
        description: "Quantas tentativas quando der lock/deadlock"
        required: true
        default: "6"

concurrency:
  group: movidesk-db
  cancel-in-progress: false

permissions:
  contents: read
  actions: write

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - run: date -u && echo "Branch=$GITHUB_REF"
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - run: python -m pip install --upgrade pip requests psycopg2-binary

      - name: Run sync_range_tickets_merged.py
        env:
          MOVIDESK_TOKEN: ${{ secrets.MOVIDESK_TOKEN }}
          NEON_DSN: ${{ secrets.NEON_DSN }}
          MOVIDESK_API_BASE: https://api.movidesk.com/public/v1

          DB_SCHEMA: visualizacao_resolvidos
          TABLE_NAME: tickets_mesclados
          CONTROL_TABLE: range_scan_control

          RESOLVIDOS_SCHEMA: visualizacao_resolvidos
          RESOLVIDOS_TABLE: tickets_resolvidos_detail
          ABERTOS_SCHEMA: visualizacao_atual
          ABERTOS_TABLE: tickets_abertos

          LIMIT: ${{ github.event.inputs.limit }}
          RPM: ${{ github.event.inputs.rpm }}
          DRY_RUN: ${{ github.event.inputs.dry_run }}
          DEBUG_TICKET_IDS: ${{ github.event.inputs.debug_ticket_ids }}

          LOCK_TIMEOUT_MS: ${{ github.event.inputs.lock_timeout_ms }}
          WRITE_RETRIES: ${{ github.event.inputs.write_retries }}

          MAX_RUNTIME_SEC: "1100"
          HTTP_TIMEOUT: "60"
          LOG_LEVEL: "INFO"
        run: python sync_range_tickets_merged.py

      - name: Dispatch self
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          set -euo pipefail
          curl -L -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${GH_TOKEN}" \
            https://api.github.com/repos/${{ github.repository }}/actions/workflows/sync_range_tickets_merged.yml/dispatches \
            -d '{"ref":"${{ github.ref_name }}","inputs":{"limit":"${{ github.event.inputs.limit }}","rpm":"${{ github.event.inputs.rpm }}","dry_run":"${{ github.event.inputs.dry_run }}","debug_ticket_ids":"${{ github.event.inputs.debug_ticket_ids }}","lock_timeout_ms":"${{ github.event.inputs.lock_timeout_ms }}","write_retries":"${{ github.event.inputs.write_retries }}"}}'
