name: Movidesk - Survey responses (raw)

on:
  workflow_dispatch:
    inputs:
      lookback_days:
        description: "Quantos dias pra trás buscar (rápido)"
        required: false
        default: "7"
      overlap_min:
        description: "Overlap em minutos (rápido)"
        required: false
        default: "1440" # 1 dia
  workflow_call:

concurrency:
  group: movidesk-survey-loop-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: read
  actions: write

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - run: date -u && echo "Branch=$GITHUB_REF"

      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install deps
        run: pip install -r requirements.txt

      - name: Run sync survey responses
        env:
          MOVIDESK_TOKEN: ${{ secrets.MOVIDESK_TOKEN }}
          NEON_DSN: ${{ secrets.NEON_DSN }}

          # rápido/contínuo
          MOVIDESK_SURVEY_DAYS: ${{ inputs.lookback_days || '7' }}
          MOVIDESK_OVERLAP_MIN: ${{ inputs.overlap_min || '1440' }}

          # mantém o resto como você já usa
          MOVIDESK_PAGE_SIZE: "100"
          MOVIDESK_THROTTLE: "0.2"
          TICKETS_CHUNK: "5000"
        run: python sync_survey_responses.py

  rerun:
    needs: sync
    if: ${{ needs.sync.result == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            const ref = context.ref.replace('refs/heads/','');
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'sync-movidesk-survey-responses.yml',
              ref
            });
