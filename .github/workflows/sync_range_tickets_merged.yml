name: scanner tickets merged (range)

on:
  workflow_dispatch:
  schedule:
    - cron: "*/10 * * * *"

permissions:
  contents: read

concurrency:
  group: scanner-tickets-merged
  cancel-in-progress: falsename: scanner tickets merged (range)

on:
  workflow_dispatch:
  schedule:
    - cron: "*/10 * * * *"

permissions:
  contents: read

concurrency:
  group: scanner-tickets-merged
  cancel-in-progress: false

jobs:
  run:
    runs-on: ubuntu-latest

    env:
      # Movidesk (SECRET)
      MOVI_TOKEN: ${{ secrets.MOVI_TOKEN }}

      # Postgres (SECRET)
      DATABASE_URL: ${{ secrets.DATABASE_URL }}

      # Range (VARIABLES)
      ID_ATUAL_MERGED: ${{ vars.ID_ATUAL_MERGED }}
      ID_FINAL_MERGED: ${{ vars.ID_FINAL_MERGED }}

      BATCH_SIZE: "80"

      DB_SCHEMA: visualizacao_resolvidos
      MERGED_TABLE: tickets_mesclados
      STATE_TABLE: tickets_mesclados_scan_state
      MISSING_TABLE: tickets_mesclados_scan_missing

      LOG_LEVEL: INFO
      DRY_RUN: "false"

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - run: |
          python -m pip install --upgrade pip
          pip install requests psycopg2-binary

      - name: Validate env presence (no secrets printed)
        run: |
          python - << 'PY'
          import os
          for k in ["MOVI_TOKEN","ID_ATUAL_MERGED","ID_FINAL_MERGED","DATABASE_URL"]:
            print(f"{k} set? {bool(os.getenv(k))}")
          PY

      - name: Run scanner
        run: |
          python sync_range_tickets_merged.py


jobs:
  run:
    runs-on: ubuntu-latest

    env:
      MOVI_TOKEN: ${{ secrets.MOVI_TOKEN }}

      # Range
      ID_ATUAL_MERGED: ${{ secrets.ID_ATUAL_MERGED }}
      ID_FINAL_MERGED: ${{ secrets.ID_FINAL_MERGED }}
      BATCH_SIZE: "80"

      # Postgres (1 secret sÃ³)
      DATABASE_URL: ${{ secrets.DATABASE_URL }}

      # Tabelas
      DB_SCHEMA: visualizacao_resolvidos
      MERGED_TABLE: tickets_mesclados
      STATE_TABLE: tickets_mesclados_scan_state
      MISSING_TABLE: tickets_mesclados_scan_missing

      LOG_LEVEL: INFO
      DRY_RUN: "false"

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - run: |
          python -m pip install --upgrade pip
          pip install requests psycopg2-binary

      - name: Validate env presence (no secrets printed)
        run: |
          python - << 'PY'
          import os
          for k in ["MOVI_TOKEN","ID_ATUAL_MERGED","ID_FINAL_MERGED","DATABASE_URL"]:
            print(f"{k} set? {bool(os.getenv(k))}")
          PY

      - name: Run scanner
        run: |
          python sync_range_tickets_merged.py
